{% extends 'layout.html' %}
{% load static %}

{% block title %}Chat with {{ other_participant.username }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card h-100" style="min-height: 600px;">
                <!-- Chat Header -->
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <a href="{% url 'conversations_list' %}" class="text-white me-3">
                            <i class="fas fa-arrow-left"></i>
                        </a>
                        {% if other_participant.profile.profile_image %}
                            <img src="{{ other_participant.profile.profile_image.url }}" 
                                 alt="{{ other_participant.username }}" 
                                 class="rounded-circle me-2" 
                                 style="width: 40px; height: 40px; object-fit: cover;">
                        {% else %}
                            <div class="rounded-circle bg-light text-primary d-flex align-items-center justify-content-center me-2" 
                                 style="width: 40px; height: 40px;">
                                <span class="fw-bold">{{ other_participant.username|first|upper }}</span>
                            </div>
                        {% endif %}
                        <div>
                            <h6 class="mb-0">{{ other_participant.get_full_name|default:other_participant.username }}</h6>
                            <small class="text-white-50">@{{ other_participant.username }}</small>
                        </div>
                    </div>
                    <div>
                        <a href="{% url 'profile' other_participant.username %}" class="text-white">
                            <i class="fas fa-user"></i> Profile
                        </a>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div class="card-body p-0 d-flex flex-column" style="height: 500px;">
                    <div id="chat-messages" class="flex-grow-1 overflow-auto p-3" style="max-height: 450px;">
                        {% for message in messages %}
                            <div class="message-container mb-3 {% if message.sender == request.user %}sent{% else %}received{% endif %}">
                                <div class="message-bubble {% if message.sender == request.user %}bg-primary text-white ms-auto{% else %}bg-light{% endif %} p-2 rounded">
                                    <div class="message-content">{{ message.content }}</div>
                                    <small class="message-time {% if message.sender == request.user %}text-white-50{% else %}text-muted{% endif %} d-block mt-1" style="font-size: 0.7rem;">
                                        {% if message.sender == request.user %}You{% else %}{{ message.sender.username }}{% endif %} • 
                                        {{ message.created_at|date:"M d, H:i" }}
                                    </small>
                                </div>
                            </div>
                        {% empty %}
                            <div class="text-center text-muted mt-5">
                                <i class="fas fa-comment text-muted" style="font-size: 2rem;"></i>
                                <p class="mt-2">No messages yet. Start the conversation!</p>
                            </div>
                        {% endfor %}
                    </div>

                    <!-- Message Input -->
                    <div class="border-top p-3">
                        <form id="message-form" class="d-flex">
                            {% csrf_token %}
                            <input type="hidden" name="conversation_id" value="{{ conversation_id }}">
                            <input type="text" 
                                   id="message-input" 
                                   name="message"
                                   class="form-control me-2" 
                                   placeholder="Type your message..." 
                                   maxlength="1000"
                                   autocomplete="off"
                                   required>
                            <button type="submit" class="btn btn-primary" id="send-button">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </form>
                        <div id="typing-indicator" class="text-muted small mt-1" style="display: none;">
                            <i class="fas fa-ellipsis-h"></i> Someone is typing...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.message-container.sent {
    display: flex;
    justify-content: flex-end;
}

.bg-light {
  --bs-bg-opacity: 1;
  background-color: rgb(255, 18, 136) !important;
}

.message-container.received {
    display: flex;
    justify-content: flex-start;
}

.message-bubble {
    max-width: 70%;
    word-wrap: break-word;
    position: relative;
}

.message-bubble.bg-primary {
    border-bottom-right-radius: 0.25rem !important;
}

.message-bubble.bg-light {
    border-bottom-left-radius: 0.25rem !important;
}

.message-time {
    font-size: 0.7rem !important;
}

#chat-messages {
    scroll-behavior: smooth;
}

#message-input:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.chat-connection-status {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
}

.message-container {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const conversationId = parseInt('{{ conversation_id }}');
    const currentUserId = parseInt('{{ request.user.id }}');
    const messageInput = document.getElementById('message-input');
    const messageForm = document.getElementById('message-form');
    const messagesContainer = document.getElementById('chat-messages');
    const sendButton = document.getElementById('send-button');
    
    let chatSocket = null;
    let isConnected = false;

    // WebSocket connection
    function connectWebSocket() {
        const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const wsPath = `${wsScheme}://${window.location.host}/ws/chat/${conversationId}/`;
        
        chatSocket = new WebSocket(wsPath);
        
        chatSocket.onopen = function(e) {
            console.log('Chat socket connected');
            isConnected = true;
            showConnectionStatus('Connected', 'success');
        };
        
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            
            if (data.error) {
                console.error('WebSocket error:', data.error);
                return;
            }
            
            addMessageToChat(data);
        };
        
        chatSocket.onclose = function(e) {
            console.log('Chat socket disconnected');
            isConnected = false;
            showConnectionStatus('Disconnected', 'danger');
            
            // Retry connection after 3 seconds
            setTimeout(connectWebSocket, 3000);
        };
        
        chatSocket.onerror = function(e) {
            console.error('WebSocket error:', e);
            isConnected = false;
            showConnectionStatus('Connection Error', 'warning');
        };
    }

    // Show connection status
    function showConnectionStatus(message, type) {
        // Remove existing status indicators
        const existingStatus = document.querySelector('.chat-connection-status');
        if (existingStatus) {
            existingStatus.remove();
        }
        
        // Create status indicator
        const statusDiv = document.createElement('div');
        statusDiv.className = `chat-connection-status alert alert-${type} alert-dismissible fade show`;
        statusDiv.innerHTML = `
            <i class="fas fa-wifi"></i> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(statusDiv);
        
        // Auto-hide success messages
        if (type === 'success') {
            setTimeout(() => {
                if (statusDiv.parentNode) {
                    statusDiv.remove();
                }
            }, 3000);
        }
    }

    // Add message to chat
    function addMessageToChat(messageData) {
        const messageContainer = document.createElement('div');
        const isCurrentUser = messageData.sender_id === currentUserId;
        
        messageContainer.className = `message-container mb-3 ${isCurrentUser ? 'sent' : 'received'}`;
        
        const messageTime = new Date(messageData.timestamp).toLocaleString('en-US', {
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        messageContainer.innerHTML = `
            <div class="message-bubble ${isCurrentUser ? 'bg-primary text-white ms-auto' : 'bg-light'} p-2 rounded">
                <div class="message-content">${escapeHtml(messageData.message)}</div>
                <small class="message-time ${isCurrentUser ? 'text-white-50' : 'text-muted'} d-block mt-1" style="font-size: 0.7rem;">
                    ${isCurrentUser ? 'You' : messageData.sender} • ${messageTime}
                </small>
            </div>
        `;
        
        messagesContainer.appendChild(messageContainer);
        scrollToBottom();
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Scroll to bottom of messages
    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Handle form submission
    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const messageText = messageInput.value.trim();
        if (!messageText) return;
        
        if (isConnected && chatSocket) {
            // Send via WebSocket
            chatSocket.send(JSON.stringify({
                'message': messageText
            }));
        } else {
            // Fallback to AJAX
            sendMessageViaAjax(messageText);
        }
        
        messageInput.value = '';
        messageInput.focus();
    });

   

    // AJAX fallback for sending messages
    function sendMessageViaAjax(messageText) {
        const formData = new FormData();
        formData.append('conversation_id', conversationId);
        formData.append('message', messageText);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch('{% url "send_message_ajax" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                addMessageToChat({
                    message: data.message.content,
                    sender: data.message.sender,
                    sender_id: data.message.sender_id,
                    timestamp: data.message.timestamp
                });
            } else {
                alert('Failed to send message: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error sending message:', error);
            alert('Failed to send message. Please try again.');
        });
    }

    // Initialize WebSocket connection
    connectWebSocket();
    
    // Focus on input field
    messageInput.focus();
    
    // Scroll to bottom on page load
    scrollToBottom();
    
    // Handle enter key in input
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            messageForm.dispatchEvent(new Event('submit'));
        }
    });
});
</script>
{% endblock %}